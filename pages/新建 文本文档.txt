tabs = st.tabs(tab_names)
# å…¨å±€å›¾åƒä¸Šä¼ å™¨
uploaded_file = None
if 'current_image' not in st.session_state:
    st.session_state.current_image = None

def load_and_display_image(uploaded_file, tab_key):
    """é€šç”¨å‡½æ•°ï¼šåŠ è½½å¹¶æ˜¾ç¤ºå›¾åƒ"""
    if uploaded_file is not None:
        try:
            # è¯»å–å›¾åƒæ–‡ä»¶
            image_bytes = uploaded_file.read()
            nparr = np.frombuffer(image_bytes, np.uint8)
            
            # ä½¿ç”¨OpenCVè¯»å–å›¾åƒ
            image = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
            
            if image is None:
                st.error("æ— æ³•è¯»å–å›¾åƒæ–‡ä»¶ï¼Œè¯·ç¡®ä¿æ˜¯æœ‰æ•ˆçš„å›¾åƒæ ¼å¼")
                return None
            
            # ä¿å­˜åˆ°session state
            st.session_state[f'image_{tab_key}'] = image
            
            # è½¬æ¢ä¸ºRGBç”¨äºæ˜¾ç¤ºï¼ˆStreamlitä½¿ç”¨RGBï¼‰
            image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
            
            return image, image_rgb
            
        except Exception as e:
            st.error(f"åŠ è½½å›¾åƒæ—¶å‡ºé”™: {str(e)}")
            return None
    return None
with tabs[0]:
    st.markdown("### ğŸ”¬ å›¾åƒå¢å¼ºå¤„ç†")
    st.markdown("""
    <div class='ideology-card'>
        <h4>ğŸ¯ æ€æ”¿å…³è”ï¼šç²¾ç›Šæ±‚ç²¾çš„å·¥åŒ ç²¾ç¥</h4>
        <p>
        å›¾åƒå¢å¼ºæŠ€æœ¯ä½“ç°äº†<strong style='color: #dc2626;'>ç²¾ç›Šæ±‚ç²¾</strong>çš„å·¥åŒ ç²¾ç¥ï¼Œ
        é€šè¿‡ä¸æ–­ä¼˜åŒ–ç»†èŠ‚ï¼Œè¿½æ±‚æ›´é«˜è´¨é‡çš„å›¾åƒæ•ˆæœï¼Œè¿™æ­£ä½“ç°äº†ç¤¾ä¼šä¸»ä¹‰æ ¸å¿ƒä»·å€¼è§‚ä¸­çš„<strong style='color: #dc2626;'>æ•¬ä¸š</strong>ç²¾ç¥ã€‚
        åœ¨æŠ€æœ¯å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬è¦å‘æ‰¬è¿™ç§ä¸€ä¸ä¸è‹Ÿã€è¿½æ±‚å“è¶Šçš„ç²¾ç¥å“è´¨ã€‚
        </p>
    </div>
    """, unsafe_allow_html=True)
    col_upload1, col_upload2 = st.columns(2)
    
    uploaded_file = None
    
    with col_upload1:
        uploaded_file = st.file_uploader(
            "ğŸ“¤ ä¸Šä¼ å›¾åƒæ–‡ä»¶", 
            type=["jpg", "jpeg", "png", "bmp", "webp"], 
            key="tab1_upload"
        )
    
    with col_upload2:
        example_files = get_example_images()
        if example_files:
            selected_example = st.selectbox(
                "ğŸ“š ä»ç´ æåº“é€‰æ‹©",
                ["-- è¯·é€‰æ‹©ç´ æ --"] + example_files,
                key="tab1_example"
            )
            
            if selected_example != "-- è¯·é€‰æ‹©ç´ æ --":
                uploaded_file = load_example_image(selected_example)
                st.success(f"âœ… å·²é€‰æ‹©ç´ æ: {selected_example}")
        else:
            st.info("ğŸ“ ç´ æåº“ä¸ºç©ºï¼Œè¯·æ·»åŠ å›¾ç‰‡åˆ°examplesæ–‡ä»¶å¤¹")
    
    if uploaded_file is not None:
        # è¯»å–å›¾åƒ
        pil_image = Image.open(uploaded_file)
        # ä¿å­˜RGBç‰ˆæœ¬ç”¨äºæ˜¾ç¤º
        image_rgb = np.array(pil_image)
        # è½¬æ¢ä¸ºBGRç”¨äºOpenCVå¤„ç†
        image_bgr = cv2.cvtColor(image_rgb, cv2.COLOR_RGB2BGR)
        
        # åˆå§‹åŒ–ç»“æœå˜é‡
        result_rgb = None
        
        col1, col2 = st.columns([2, 1])
        with col1:
            st.markdown('<div class="image-container">', unsafe_allow_html=True)
            # æ˜¾ç¤ºRGBç‰ˆæœ¬ï¼ˆæ­£ç¡®çš„é¢œè‰²ï¼‰
            st.image(image_rgb, caption="åŸå§‹å›¾åƒ", use_container_width=True)
            st.markdown('</div>', unsafe_allow_html=True)
        
        # å¢å¼ºæ–¹æ³•é€‰æ‹©
        enhancement_method = st.selectbox(
            "é€‰æ‹©å¢å¼ºæ–¹æ³•",
            ["ç›´æ–¹å›¾å‡è¡¡åŒ–", "å¯¹æ¯”åº¦è°ƒæ•´", "ä¼½é©¬æ ¡æ­£", "CLAHEå¢å¼º"]
        )
        
        col1, col2 = st.columns(2)
        with col1:
            if enhancement_method == "å¯¹æ¯”åº¦è°ƒæ•´":
                alpha = st.slider("å¯¹æ¯”åº¦ç³»æ•°", 0.5, 3.0, 1.2, 0.1)
                beta = st.slider("äº®åº¦è°ƒæ•´", -50, 50, 0)
                if st.button("åº”ç”¨å¯¹æ¯”åº¦è°ƒæ•´", use_container_width=True):
                    # ä½¿ç”¨BGRç‰ˆæœ¬è¿›è¡Œå¤„ç†
                    result_bgr = apply_contrast_adjustment(image_bgr, alpha, beta)
                    # è½¬æ¢ä¸ºRGBç”¨äºæ˜¾ç¤º
                    result_rgb = cv2.cvtColor(result_bgr, cv2.COLOR_BGR2RGB)
                    
            elif enhancement_method == "ä¼½é©¬æ ¡æ­£":
                gamma = st.slider("ä¼½é©¬å€¼", 0.1, 3.0, 1.0, 0.1)
                if st.button("åº”ç”¨ä¼½é©¬æ ¡æ­£", use_container_width=True):
                    # ä½¿ç”¨BGRç‰ˆæœ¬è¿›è¡Œå¤„ç†
                    result_bgr = apply_gamma_correction(image_bgr, gamma)
                    # è½¬æ¢ä¸ºRGBç”¨äºæ˜¾ç¤º
                    result_rgb = cv2.cvtColor(result_bgr, cv2.COLOR_BGR2RGB)
                    
            elif enhancement_method == "CLAHEå¢å¼º":
                clip_limit = st.slider("å¯¹æ¯”åº¦é™åˆ¶", 1.0, 4.0, 2.0, 0.1)
                tile_size = st.slider("ç½‘æ ¼å¤§å°", 4, 16, 8, 2)
                if st.button("åº”ç”¨CLAHEå¢å¼º", use_container_width=True):
                    # ä½¿ç”¨BGRç‰ˆæœ¬è¿›è¡Œå¤„ç†
                    result_bgr = apply_clahe(image_bgr, clip_limit, (tile_size, tile_size))
                    # è½¬æ¢ä¸ºRGBç”¨äºæ˜¾ç¤º
                    result_rgb = cv2.cvtColor(result_bgr, cv2.COLOR_BGR2RGB)
                    
            else:  # ç›´æ–¹å›¾å‡è¡¡åŒ–
                if st.button("åº”ç”¨ç›´æ–¹å›¾å‡è¡¡åŒ–", use_container_width=True):
                    # ä½¿ç”¨BGRç‰ˆæœ¬è¿›è¡Œå¤„ç†
                    result_bgr = apply_histogram_equalization(image_bgr)
                    # è½¬æ¢ä¸ºRGBç”¨äºæ˜¾ç¤º
                    result_rgb = cv2.cvtColor(result_bgr, cv2.COLOR_BGR2RGB)
        
        with col2:
            if result_rgb is not None:
                st.markdown('<div class="image-container">', unsafe_allow_html=True)
                st.image(result_rgb, caption=f"{enhancement_method}ç»“æœ", use_container_width=True)
                st.markdown('</div>', unsafe_allow_html=True)
                
                # æ˜¾ç¤ºå¯¹æ¯”å’Œç›´æ–¹å›¾
                display_comparison_with_histograms(
                    image_rgb, 
                    result_rgb, 
                    original_title="åŸå§‹å›¾åƒ", 
                    processed_title=f"{enhancement_method}ç»“æœ"
                )
                
                # ä¸‹è½½æ—¶ä½¿ç”¨RGBç‰ˆæœ¬
                provide_download_button(
                    result_rgb, 
                    f"enhanced_{enhancement_method}.jpg", 
                    "ğŸ“¥ ä¸‹è½½å¢å¼ºç»“æœ",
                    unique_key_suffix="tab1_enhance"
                )
    else:
        st.info("ğŸ“¤ è¯·ä¸Šä¼ å›¾åƒæ–‡ä»¶æˆ–ä»ç´ æåº“é€‰æ‹©å›¾ç‰‡å¼€å§‹å¤„ç†")
# 2. è¾¹ç¼˜æ£€æµ‹é€‰é¡¹å¡
with tabs[1]:
    st.markdown("### ğŸ“ è¾¹ç¼˜æ£€æµ‹ç®—æ³•æ¯”è¾ƒ")
    
    st.markdown("""
    <div class='ideology-card'>
        <h4>ğŸ¯ æ€æ”¿å…³è”ï¼šä¸¥è°¨çš„ç§‘å­¦æ€åº¦</h4>
        <p>
        è¾¹ç¼˜æ£€æµ‹ç®—æ³•ä½“ç°äº†<strong style='color: #dc2626;'>ä¸¥è°¨æ±‚å®</strong>çš„ç§‘å­¦æ€åº¦ï¼Œ
        ä¸åŒç®—æ³•å„æœ‰ä¼˜åŠ£ï¼Œéœ€è¦æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©ï¼Œè¿™ä½“ç°äº†<strong style='color: #dc2626;'>å®äº‹æ±‚æ˜¯</strong>çš„ç§‘å­¦ç²¾ç¥ã€‚
        åœ¨æŠ€æœ¯ç ”ç©¶ä¸­ï¼Œæˆ‘ä»¬è¦ä¿æŒä¸¥è°¨çš„æ€åº¦ï¼Œè¿½æ±‚çœŸç†ã€‚
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # ===== åŒåˆ—å¸ƒå±€ï¼šå·¦ä¾§ä¸Šä¼ ï¼Œå³ä¾§ç´ æåº“ =====
    col_upload1, col_upload2 = st.columns(2)
    
    uploaded_file = None
    
    with col_upload1:
        uploaded_file = st.file_uploader(
            "ğŸ“¤ ä¸Šä¼ å›¾åƒæ–‡ä»¶", 
            type=["jpg", "jpeg", "png", "bmp", "webp"], 
            key="tab2_upload"
        )
    
    with col_upload2:
        # ç´ æåº“é€‰æ‹©
        example_files = get_example_images()
        
        if example_files:
            selected_example = st.selectbox(
                "ğŸ“š ä»ç´ æåº“é€‰æ‹©",
                ["-- è¯·é€‰æ‹©ç´ æ --"] + example_files,
                key="tab2_example"
            )
            
            if selected_example != "-- è¯·é€‰æ‹©ç´ æ --":
                uploaded_file = load_example_image(selected_example)
                st.success(f"âœ… å·²é€‰æ‹©ç´ æ: {selected_example}")
        else:
            st.info("ğŸ“ ç´ æåº“ä¸ºç©ºï¼Œè¯·æ·»åŠ å›¾ç‰‡åˆ°examplesæ–‡ä»¶å¤¹")
    
    if uploaded_file is not None:
        # è¯»å–å›¾åƒ
        pil_image = Image.open(uploaded_file)
        # ä¿å­˜RGBç‰ˆæœ¬ç”¨äºæ˜¾ç¤º
        image_rgb = np.array(pil_image)
        # è½¬æ¢ä¸ºBGRç”¨äºOpenCVå¤„ç†
        image_bgr = cv2.cvtColor(image_rgb, cv2.COLOR_RGB2BGR)
        
        # åˆå§‹åŒ–ç»“æœå˜é‡
        canny_result_rgb = None
        sobel_result_rgb = None
        laplacian_result_rgb = None
